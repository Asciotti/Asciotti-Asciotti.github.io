
<!DOCTYPE html>
<html>

<link href='https://fonts.googleapis.com/css?family=Lato:300,900' rel='stylesheet' type='text/css'>
<script src='https://d3js.org/d3.v5.min.js'></script>
<style>
    /*circle {fill: lightblue; stroke: darkred;}*/
    div.tooltip {
        position: absolute;
        text-align: center;
        width: 110px;
        height: 32px;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }

    svg {
        background-color: GhostWhite;
        font-family: 'Lato';
    }

    .annotation-group, text.title {
        font-size: .9em;
    }

    .annotation-group2, text.title {
        font-size: .8em;
    }

    .annotation-group3, text.title {
        font-size: 1em;
    }

    text.title {
        font-size: .8em;
    }
</style>
<body onload='init()'>

<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

<h1> GDP vs Life expectancy for countries, and how it has changed over years</h1><br/>
<svg width=1800 height=900>

</svg>
<script>

    let regions = []
    let selected_makes = []
    let cylinders = ["<-Prev", 4, 6, 8, "Next->"]
    let select_year = 4
    let select_cylinder = 4
    let csv_data, xs, ys, cs = null

    async function init() {
    d3.csv("https://raw.githubusercontent.com/Asciotti/dataviz-419-proj/master/CO2%20Emissions_Canada.csv", 
            function(d) {
          return {
                Make: d["Make"],
                Model: d["Model"],
                Transmission: d["Transmission-mod"],
                Fuel: d["Fuel Type"],
                EngineSize: +d["Engine Size(L)"],
                Cylinders: +d["Cylinders"],
                CO2Emissions: +d["CO2 Emissions(g/km)"],

          };})
        .then(function(data) {
            let margin = 60
            let svg_dim = 700
            let svg_dim2 = 1700
            let max_gdp = 0
            let max_lifeexp = 0

            csv_data = data
            console.log(data)


            const annotations = [].map(function(d){ d.color = "Blue"; return d})


            const makeAnnotations = d3.annotation()
                .type(d3.annotationLabel)
                .annotations(annotations)

            const annotations2 = [
                {
                    type: d3.annotationCallout,
                    note: {
                        label: "Click Next or previous to see changes in Engine Size and CO2 Emissions over number of cylinders, or select a number of cylinders by clicking on it",
                        title: "Slide Show",
                        wrap: 240
                    },
                    x: 920,
                    y: 30,
                    dy: 5,
                    dx: 10
                }].map(function(d){ d.color = "grey"; return d})


            const makeAnnotations2 = d3.annotation()
                .type(d3.annotationLabel)
                .annotations(annotations2)

            const annotations3 = [
                // {
                //     type: d3.annotationCallout,
                //     note: {
                //         label: "UAE GDP reduces, impacted by the start of the housing bubble burst",
                //         title: "2007",
                //         wrap: 160
                //     },
                //     x: 1520,
                //     y: 210,
                //     dy: -40,
                //     dx: -680,
                //     className: "annotation2007"
                // },
                  ].map(function(d){ d.color = "Blue"; return d})


            const makeAnnotations3 = d3.annotation()
                .type(d3.annotationLabel)
                .annotations(annotations3)

            clear_all = []
            d3.selectAll("g").data(clear_all).exit().remove()

            //find minimum and maximum for EngineSize and CO2 emissions to use for axis limits

            let engine_size_extent = d3.extent(data, d=>d.EngineSize)
            console.log(engine_size_extent)
            let co2_extent = d3.extent(data, d=>d.CO2Emissions)
            console.log(co2_extent)


            makes = d3.map(data, function(d){return d.Make;}).keys()
            selected_makes = [...makes]
            console.log('hi')
            console.log(makes)
            xs = d3.scaleLinear().domain(engine_size_extent).range([0,svg_dim2]);
            ys = d3.scaleLinear().domain(co2_extent).range([svg_dim,0]);
            cs = d3.scaleOrdinal().domain(makes).range(d3.schemeCategory10)
            //cs = d3.scaleOrdinal().domain(regions).range(d3.schemeTableau10)//d3.schemeCategory10)


            d3.select("svg")
                .selectAll("g")
                .data(cylinders)
                .enter()
                .append("g")
                .attr("transform", function(d, i) { return "translate(" + (80+i*65) + ",30)"; })
                .append("text")
                .text(function(d,i){return(cylinders[i])})
                .style('font-weight', 600)

            // Define the div for the tooltip
            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            //Add cylinder as rectangles and onclick logic to change chart
            d3.select("svg")
                .selectAll("g")
                .each(function(d, i)
                {
                    d3.select(this).append("rect")
                        .attr("id", "cylinder"+String(d))
                        .attr('x', -5)
                        .attr('y', -15)
                        .attr('opacity', .2)
                        .attr('width', 55)
                        .attr('height', 20)
                        .attr('stroke', 'black')
                        .attr('fill', function(d,i)
                        {
                            if(d=="<-Prev" || d=="Next->") return("yellow")
                            if(Number(d)===4) return('blue');
                            else return ('brown');
                        })
                        .on('click', function(d,i)
                        {
                            d3.selectAll("rect").attr("fill", function(d)
                            {
                                if(d=="Next->" || d=="<-Prev") return ("yellow");
                                else return ("brown")
                            })

                            d3.select(this)
                                .attr("fill", function(d)
                                {
                                    if(d=="Next->" || d=="<-Prev") return ("yellow");
                                    else return ("blue")
                                })

                            if(d=="Next->"){
                                let cy_index = cylinders.indexOf(select_cylinder)
                                if(cy_index < (cylinders.length - 2)) select_cylinder = cylinders[cy_index+1]
                            }
                            
                            else if(d=="<-Prev")
                            {
                                let cy_index = cylinders.indexOf(select_cylinder)
                                if(cy_index > 1) select_cylinder = cylinders[cy_index-1]
                            }
                            else select_cylinder = Number(d);
                            console.log(select_cylinder)
                            let id_selected = "#cylinder" + String(select_cylinder)
                            d3.select(id_selected).attr("fill", "blue")

                            plot_points()

                            // show_year_annotation(select_year)
                        });
                })

            d3.select('svg')
                .append('g')
                .attr("id", "chart")
                .attr('transform','translate(' + margin + ',' + margin + ')')

            //Filter dataset to be just the year selected
            let select_cylinder_data = data.filter(function(e){return (e.Cylinders==select_cylinder)})

            let chart = d3.select("#chart")


            // // Add one dot in the legend for each name.
            // chart.selectAll("mydots")
            //     .data(regions)
            //     .enter()
            //     .append("circle")
            //     .attr("cx", 1420)
            //     .attr("cy", function(d,i){ return 550 + i*20}) // 10 is where the first dot appears. 20 is the distance between dots
            //     .attr("r", 5)
            //     .style("fill", function(d){ return cs(d)})

            // chart.selectAll("foreignObject")
            //     .data(regions).enter()
            //     .append("foreignObject")
            //     .attr('x', 1440)
            //     .attr('y',  function(d,i){ return 550-10 + i*20})
            //     .attr('width', 290)
            //     .attr('height', 20)
            //     .append("xhtml:tree")
            //     .html(function(d, i){
            //         let s = "<label style='color:" + cs(d)
            //             + "'><input type='checkbox' checked=true id='" + d
            //             + "' onclick=ARegionClicked(this)>" + d + "</label>"
            //         return(s);
            //     })
            //     .style("fill", function(d){ return cs(d)})

            //Add circles as points in graph
            chart.selectAll("g")
                .data(select_cylinder_data)
                .enter()
                .append("g")
                .attr("id", function(d){return(d.Make)})
                .attr("transform", function(d, i) {
                    let co2_emiss = ys(d.CO2Emissions)
                    let engine_size = xs(d.EngineSize)
                    return "translate(" + engine_size + "," + co2_emiss + ")"; })
                // .on("mouseover", function(d) {
                //     if(selected_regions.includes(d["Region"])){
                //         div.transition()
                //             .duration(200)
                //             .style("opacity", .9);
                //         div.html(function(){return(d["Country Name"]
                //             + "<br/> GDP = $"+ Math.round(Number(d["GDP per capita, PPP (constant 2017 international $) [NY.GDP.PCAP.PP.KD]"])))
                //         })
                //             .style("left", (d3.event.pageX) + "px")
                //             .style("top", (d3.event.pageY - 28) + "px");
                //     }
                // })
                // .on("mouseout", function(d) {
                //     div.transition()
                //         .duration(500)
                //         .style("opacity", 0);
                // })
                .append("circle").attr("r", 4).attr("opacity", 0)
                .attr("fill", function(d, i){return(cs(d.Fuel))})
                .transition()
                .duration(2000).delay(function(d,i) {
                  console.log(d.Cylinders)
                  if (d.Fuel == "X")
                    return 500
                  if (d.Fuel == "Z")
                    return 1000
                  if (d.Fuel == "D")
                    return 1500
                })
                .ease(d3.easeLinear)
                .attr("opacity",1)

            //Decide which country codes to show and which to hide to avoid overlapping
            // let counter = 0;
            // var nest = d3.nest()
            //     .key(function(d) { return d.Make; })
            //     .entries(data);
            // console.log(nest)
            // chart.selectAll("g")
            //     .each(function(d, i)
            //     {
            //         d3.select(this)
            //             .append("text").text(function (d, i){
            //                 let country_code = d.Model
            //                 let life_exp = d.CO2Emissions
            //                 let gdp = d.EngineSize
            //                 counter++;
            //                 if((gdp<=2)){
            //                     if(counter%75 != 0) return ("");
            //                 }
            //                 if((gdp>2 & gdp<=4)){
            //                     if(counter%75 != 0) return ("");
            //                 }
            //                 if((gdp>4 & gdp<=6)){
            //                     if(counter%75 != 0) return ("");
            //                 }
            //                 if((gdp>6 & gdp<=8)){
            //                     if(counter%25 != 0) return ("");
            //                 }
                            
            //                 // if(counter%75 != 0) return ("");
            //                 return (d.Make + ", "+ country_code)
            //             })
            //             .attr("font-size", 10)
            //             .attr("x", 5)
            //             .attr("y", -4 + Math.round(Math.random())*-20)
            //     })

            d3.select("svg").append("g")
                .attr("transform", "translate(" + margin + "," + margin + ")")
                .call(d3.axisLeft(ys).tickFormat(d3.format("~s")))

            d3.select("svg").append("g")
                .attr("transform", "translate(" + margin + "," + (svg_dim+margin) + ")")
                .call(d3.axisBottom(xs).tickFormat(d3.format("~s")))

            d3.select("svg").append("text")
                .attr("class", "x label")
                .attr("text-anchor", "end")
                .attr("x", 1000)
                .attr("y", 1.75*margin+svg_dim)
                .style('fill', 'Black')
                .style('font-weight', 'bold')
                .text("Engine Size in Liters")

            d3.select("svg").append("text")
                .attr("class", "y label")
                .attr("text-anchor", "end")
                .attr("x", -svg_dim/3)
                .attr("y", 20)
                .attr("dy", ".25em")
                .style('fill', 'Black')
                .style('font-weight', 'bold')
                .attr("transform", "rotate(-90)")
                .text("CO2 Emissions in g/km");

            d3.select("svg")
                .append("g")
                .attr("class", "annotation-group")
                .call(makeAnnotations)

            d3.select("svg")
                .append("g")
                .attr("class", "annotation-group2")
                .call(makeAnnotations2)

            d3.select("svg")
                .append("g")
                .attr("class", "annotation-group3")
                .call(makeAnnotations3)

            show_year_annotation(select_year)

        })
        .catch(function(error){
            // handle error
            console.log("in catch error of d3.csv")
            console.log(error)
        })
    }

    function ARegionClicked(object){
        let checked = object.checked
        let clicked_region = object.id

        if (!checked){
            selected_regions.splice(selected_regions.indexOf(clicked_region),1);
            if(clicked_region=="Sub-Saharan Africa"){
                d3.select(".Africa").attr("opacity", 0);
                d3.select(".annotation2008").attr("opacity", 0);
                d3.select(".annotation2013").attr("opacity", 0);
                d3.select(".annotation2015_03").attr("opacity", 0);
            }
            if(clicked_region=="Middle East & North Africa"){
                d3.select(".annotation2007").attr("opacity", 0);
                d3.select(".annotation2011").attr("opacity", 0);
                d3.select(".annotation2012").attr("opacity", 0);
            }
            if(clicked_region=="North America") d3.select(".NorthAmerica").attr("opacity", 0)
            if(clicked_region=="Europe & Central Asia") d3.select(".annotation2015_02").attr("opacity", 0);
            if(clicked_region=="East Asia & Pacific") d3.select(".annotation2015").attr("opacity", 0);
        }
        else{
            selected_regions.push(clicked_region);
            if(clicked_region=="Sub-Saharan Africa"){
                d3.select(".Africa").attr("opacity", 1);
                if(select_year==2008) d3.select(".annotation2008").attr("opacity", 1);
                if(select_year==2013) d3.select(".annotation2013").attr("opacity", 1);
                if(select_year==2015) d3.select(".annotation2015_03").attr("opacity", 1);
            }
            if(clicked_region=="Middle East & North Africa"){
                if(select_year==2007) d3.select(".annotation2007").attr("opacity", 1);
                if(select_year==2011) d3.select(".annotation2011").attr("opacity", 1);
                if(select_year==2012) d3.select(".annotation2012").attr("opacity", 1);
            }
            if(clicked_region=="North America") d3.select(".NorthAmerica").attr("opacity", 1);
            if(clicked_region=="Europe & Central Asia"){
                if(select_year==2015) d3.select(".annotation2015_02").attr("opacity", 1);
            }
            if(clicked_region=="East Asia & Pacific"){
                if(select_year==2015) d3.select(".annotation2015").attr("opacity", 1);
            }
        }

        plot_points();
    }

    function plot_points(){
        console.log('hi!')
        d3.select("#chart").selectAll("circle").data(clear_all).exit().remove()
        let cur_x = 0
        let cur_y = 0
        console.log(select_cylinder)
        let select_cylinder_data = csv_data.filter(function(e){return (e.Cylinders==select_cylinder)})
        console.log('startimg!')
        d3.select("#chart").selectAll("circle").data(clear_all).exit().remove()
                .data(select_cylinder_data)
                .enter()
                .append("g")
                .attr("id", function(d){return(d.Make)})
                .attr("transform", function(d, i) {
                    let co2_emiss = ys(d.CO2Emissions)
                    let engine_size = xs(d.EngineSize)
                    return "translate(" + engine_size + "," + co2_emiss + ")"; })
                // .on("mouseover", function(d) {
                //     if(selected_regions.includes(d["Region"])){
                //         div.transition()
                //             .duration(200)
                //             .style("opacity", .9);
                //         div.html(function(){return(d["Country Name"]
                //             + "<br/> GDP = $"+ Math.round(Number(d["GDP per capita, PPP (constant 2017 international $) [NY.GDP.PCAP.PP.KD]"])))
                //         })
                //             .style("left", (d3.event.pageX) + "px")
                //             .style("top", (d3.event.pageY - 28) + "px");
                //     }
                // })
                // .on("mouseout", function(d) {
                //     div.transition()
                //         .duration(500)
                //         .style("opacity", 0);
                // })
                .append("circle").attr("r", 4).attr("opacity", 0)
                .attr("fill", function(d, i){return(cs(d.Fuel))})
                .transition()
                .duration(2000).delay(function(d,i) {
                  console.log(d.Cylinders)
                  if (d.Fuel == "X")
                    return 500
                  if (d.Fuel == "Z")
                    return 1000
                  if (d.Fuel == "D")
                    return 1500
                })
                .ease(d3.easeLinear)
                .attr("opacity",1)
        console.log('ending!')
    }

    function show_year_annotation(select_year){
        d3.select(".annotation2007").attr("opacity",0)
        d3.select(".annotation2008").attr("opacity",0)
        d3.select(".annotation2009").attr("opacity",0)
        d3.select(".annotation2011").attr("opacity",0)
        d3.select(".annotation2012").attr("opacity",0)
        d3.select(".annotation2013").attr("opacity",0)
        d3.select(".annotation2015").attr("opacity",0)
        d3.select(".annotation2015_02").attr("opacity",0)
        d3.select(".annotation2015_03").attr("opacity",0)
        if(select_year==2007) if(selected_regions.includes("Middle East & North Africa")) d3.select(".annotation2007").attr("opacity",1);
        if(select_year==2008) if(selected_regions.includes("Sub-Saharan Africa")) d3.select(".annotation2008").attr("opacity",1);
        if(select_year==2009) d3.select(".annotation2009").attr("opacity",1);
        if(select_year==2011) if(selected_regions.includes("Middle East & North Africa")) d3.select(".annotation2011").attr("opacity",1);
        if(select_year==2012) if(selected_regions.includes("Middle East & North Africa")) d3.select(".annotation2012").attr("opacity",1);
        if(select_year==2013) if(selected_regions.includes("Sub-Saharan Africa")) d3.select(".annotation2013").attr("opacity",1);
        if(select_year==2015) if(selected_regions.includes("East Asia & Pacific")) d3.select(".annotation2015").attr("opacity",1);
        if(select_year==2015) if(selected_regions.includes("Europe & Central Asia")) d3.select(".annotation2015_02").attr("opacity",1);
        if(select_year==2015) if(selected_regions.includes("Sub-Saharan Africa")) d3.select(".annotation2015_03").attr("opacity",1);
    }

</script>
</body>
</html>
